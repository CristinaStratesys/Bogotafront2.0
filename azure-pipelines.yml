# Pipeline Frontend - Bogota Chamber of Commerce
# Ejecución MANUAL desde Azure DevOps
# Build → Push to ACR → Deploy to Azure Container Apps

trigger: none

pr: none

variables:
  - group: azure-resources
  - group: supabase-credentials
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: imageRepository
    value: 'bogota-frontend'
  - name: tag
    value: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Docker Image'
    jobs:
      - job: BuildAndPush
        displayName: 'Build Docker Image'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - checkout: self
            displayName: 'Checkout code'
          
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: 'acr-connection'
          
          - task: Bash@3
            displayName: 'Create .env file for build'
            inputs:
              targetType: 'inline'
              script: |
                echo "Creating .env file with Supabase credentials..."
                cat > $(Build.SourcesDirectory)/.env << INNEREOF
                VITE_SUPABASE_URL=$(VITE_SUPABASE_URL)
                VITE_SUPABASE_KEY=$(VITE_SUPABASE_KEY)
                INNEREOF
                echo "Done creating .env file"
          
          - task: Docker@2
            displayName: 'Build Docker image'
            inputs:
              command: build
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: 'acr-connection'
              tags: |
                $(tag)
                latest
              arguments: '--no-cache'
          
          - task: Docker@2
            displayName: 'Push image to ACR'
            inputs:
              command: push
              repository: $(imageRepository)
              containerRegistry: 'acr-connection'
              tags: |
                $(tag)
                latest
          
          - task: Bash@3
            displayName: 'Cleanup .env file'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                rm -f $(Build.SourcesDirectory)/.env

  - stage: Deploy
    displayName: 'Deploy to Azure Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployFrontend
        displayName: 'Deploy Frontend to Container Apps'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to Container App'
                  inputs:
                    azureSubscription: 'azure-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying frontend to Azure Container Apps..."
                      
                      az containerapp update \
                        --name $(FRONTEND_APP_NAME) \
                        --resource-group $(RESOURCE_GROUP) \
                        --image $(ACR_LOGIN_SERVER)/$(imageRepository):$(tag) \
                        --cpu 0.5 \
                        --memory 1.0Gi \
                        --min-replicas 1 \
                        --max-replicas 3
                      
                      FRONTEND_URL=$(az containerapp show \
                        --name $(FRONTEND_APP_NAME) \
                        --resource-group $(RESOURCE_GROUP) \
                        --query properties.configuration.ingress.fqdn \
                        --output tsv)
                      
                      echo "Frontend deployed successfully!"
                      echo "Frontend URL: https://$FRONTEND_URL"
